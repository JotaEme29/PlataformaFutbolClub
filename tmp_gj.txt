// src/components/GestionJugadores.jsx - GESTIÃ“N DE JUGADORES PARA PLATAFORMA FÃšTBOL 2.0

import { useState, useEffect } from 'react';
import { useAuth } from '../context/AuthContext';
import { db } from '../firebase';
import {
  collection,
  addDoc,
  getDocs,
  doc,
  updateDoc,
  deleteDoc,
  serverTimestamp,
  query,
  where,
  orderBy
} from 'firebase/firestore';

function GestionJugadores() {
  const { currentUser } = useAuth();
  const [equipos, setEquipos] = useState([]);
  const [selectedTeam, setSelectedTeam] = useState('');
  const [jugadores, setJugadores] = useState([]);
  const [showNewPlayerForm, setShowNewPlayerForm] = useState(false);
  const [showInviteForm, setShowInviteForm] = useState(false);
  const [loading, setLoading] = useState(true);
  const [newPlayer, setNewPlayer] = useState({
    nombre: '',
    apellido: '',
    fechaNacimiento: '',
    posicion: '',
    numeroCamiseta: '',
    telefono: '',
    email: '',
    direccion: '',
    contactoEmergencia: '',
    telefonoEmergencia: ''
  });
  const [inviteData, setInviteData] = useState({
    email: '',
    rol: 'jugador',
    equipoId: ''
  });

  const posiciones = [
    'Portero',
    'Defensa Central',
    'Lateral Derecho',
    'Lateral Izquierdo',
    'Mediocentro Defensivo',
    'Mediocentro',
    'Mediocentro Ofensivo',
    'Extremo Derecho',
    'Extremo Izquierdo',
    'Delantero Centro',
    'Segundo Delantero'
  ];

  const roles = [
    { value: 'jugador', label: 'Jugador' },
    { value: 'entrenador', label: 'Entrenador' },
    { value: 'asistente', label: 'Entrenador Asistente' }
  ];

  useEffect(() => {
    if (currentUser?.clubId) {
      loadEquipos();
    }
  }, [currentUser]);

  useEffect(() => {
    if (selectedTeam) {
      loadJugadores();
    }
  }, [selectedTeam]);

  const loadEquipos = async () => {
    try {
      setLoading(true);
      const equiposRef = collection(db, 'clubes', currentUser.clubId, 'equipos');
      const equiposSnapshot = await getDocs(equiposRef);
      const equiposData = equiposSnapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      setEquipos(equiposData);
    } catch (error) {
      console.error('Error al cargar equipos:', error);
    } finally {
      setLoading(false);
    }
  };

  const loadJugadores = async () => {
    try {
      const jugadoresRef = collection(db, 'clubes', currentUser.clubId, 'equipos', selectedTeam, 'jugadores');
      const q = query(jugadoresRef, orderBy('numeroCamiseta', 'asc'));
      const jugadoresSnapshot = await getDocs(q);
      const jugadoresData = jugadoresSnapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      setJugadores(jugadoresData);
    } catch (error) {
      console.error('Error al cargar jugadores:', error);
    }
  };

  const handleCreatePlayer = async (e) => {
    e.preventDefault();
    
    const selectedTeamData = equipos.find(eq => eq.id === selectedTeam);
    const maxJugadores = getMaxJugadores(selectedTeamData?.formato || 11);
    
    if (jugadores.length >= maxJugadores) {
      alert(`Has alcanzado el lÃ­mite mÃ¡ximo de ${maxJugadores} jugadores para este formato de equipo`);
      return;
    }

    // Verificar que el nÃºmero de camiseta no estÃ© ocupado
    const numeroExiste = jugadores.some(j => j.numeroCamiseta === parseInt(newPlayer.numeroCamiseta));
    if (numeroExiste) {
      alert('El nÃºmero de camiseta ya estÃ¡ ocupado por otro jugador');
      return;
    }

    try {
      const jugadoresRef = collection(db, 'clubes', currentUser.clubId, 'equipos', selectedTeam, 'jugadores');
      await addDoc(jugadoresRef, {
        ...newPlayer,
        numeroCamiseta: parseInt(newPlayer.numeroCamiseta),
        fechaNacimiento: new Date(newPlayer.fechaNacimiento),
        fechaRegistro: serverTimestamp(),
        activo: true,
        estadisticas: {
          partidosJugados: 0,
          goles: 0,
          asistencias: 0,
          tarjetasAmarillas: 0,
          tarjetasRojas: 0,
          minutosJugados: 0
        }
      });

      setNewPlayer({
        nombre: '',
        apellido: '',
        fechaNacimiento: '',
        posicion: '',
        numeroCamiseta: '',
        telefono: '',
        email: '',
        direccion: '',
        contactoEmergencia: '',
        telefonoEmergencia: ''
      });
      setShowNewPlayerForm(false);
      loadJugadores();
    } catch (error) {
      console.error('Error al crear jugador:', error);
    }
  };

  const handleSendInvite = async (e) => {
    e.preventDefault();
    
    try {
      const invitacionesRef = collection(db, 'invitaciones');
      await addDoc(invitacionesRef, {
        ...inviteData,
        clubId: currentUser.clubId,
        clubNombre: currentUser.club?.nombre,
        invitadoPor: currentUser.uid,
        fechaInvitacion: serverTimestamp(),
        estado: 'pendiente'
      });

      alert('InvitaciÃ³n enviada exitosamente');
      setInviteData({ email: '', rol: 'jugador', equipoId: '' });
      setShowInviteForm(false);
    } catch (error) {
      console.error('Error al enviar invitaciÃ³n:', error);
    }
  };

  const handleDeletePlayer = async (playerId) => {
    if (window.confirm('Â¿EstÃ¡s seguro de que quieres eliminar este jugador? Esta acciÃ³n no se puede deshacer.')) {
      try {
        const playerDocRef = doc(db, 'clubes', currentUser.clubId, 'equipos', selectedTeam, 'jugadores', playerId);
        await deleteDoc(playerDocRef);
        loadJugadores();
      } catch (error) {
        console.error('Error al eliminar jugador:', error);
      }
    }
  };

  const getMaxJugadores = (formato) => {
    const limites = {
      5: 10,
      7: 14,
      8: 16,
      9: 18,
      11: 25
    };
    return limites[formato] || 25;
  };

  const calcularEdad = (fechaNacimiento) => {
    if (!fechaNacimiento) return 'N/A';
    const hoy = new Date();
    const nacimiento = fechaNacimiento.toDate ? fechaNacimiento.toDate() : new Date(fechaNacimiento);
    const edad = hoy.getFullYear() - nacimiento.getFullYear();
    const mesActual = hoy.getMonth();
    const mesNacimiento = nacimiento.getMonth();
    
    if (mesActual < mesNacimiento || (mesActual === mesNacimiento && hoy.getDate() < nacimiento.getDate())) {
      return edad - 1;
    }
    return edad;
  };

  if (loading) {
    return <div className="loading">Cargando equipos...</div>;
  }

  return (
    <div className="gestion-jugadores">
      <div className="jugadores-header">
        <h2>GestiÃ³n de Jugadores</h2>
        <div className="team-selector">
          <label htmlFor="team-select">Seleccionar Equipo:</label>
          <select
            id="team-select"
            value={selectedTeam}
            onChange={(e) => setSelectedTeam(e.target.value)}
          >
            <option value="">Selecciona un equipo</option>
            {equipos.map(equipo => (
              <option key={equipo.id} value={equipo.id}>
                {equipo.nombre} (FÃºtbol {equipo.formato})
              </option>
            ))}
          </select>
        </div>
      </div>

      {selectedTeam && (
        <>
          <div className="jugadores-actions">
            <div className="team-info">
              {(() => {
                const team = equipos.find(eq => eq.id === selectedTeam);
                return (
                  <div className="team-stats">
                    <h3>{team?.nombre}</h3>
                    <p><strong>Formato:</strong> FÃºtbol {team?.formato}</p>
                    <p><strong>Jugadores:</strong> {jugadores.length}/{getMaxJugadores(team?.formato)}</p>
                    <p><strong>Entrenador:</strong> {team?.entrenador || 'No asignado'}</p>
                  </div>
                );
              })()}
            </div>
            <div className="action-buttons">
              <button 
                className="btn-primary"
                onClick={() => setShowNewPlayerForm(true)}
              >
                + AÃ±adir Jugador
              </button>
              <button 
                className="btn-secondary"
                onClick={() => setShowInviteForm(true)}
              >
                ðŸ“§ Enviar InvitaciÃ³n
              </button>
            </div>
          </div>

          {/* Lista de Jugadores */}
          <div className="jugadores-grid">
            {jugadores.map(jugador => (
              <div key={jugador.id} className="jugador-card">
                <div className="jugador-header">
                  <div className="numero-camiseta">#{jugador.numeroCamiseta}</div>
                  <div className="jugador-info">
                    <h4>{jugador.nombre} {jugador.apellido}</h4>
                    <p className="posicion">{jugador.posicion}</p>
                  </div>
                </div>
                <div className="jugador-details">
                  <p><strong>Edad:</strong> {calcularEdad(jugador.fechaNacimiento)} aÃ±os</p>
                  <p><strong>TelÃ©fono:</strong> {jugador.telefono || 'No especificado'}</p>
                  <p><strong>Email:</strong> {jugador.email || 'No especificado'}</p>
                </div>
                <div className="jugador-stats">
                  <div className="stat-item">
                    <span className="stat-value">{jugador.estadisticas?.partidosJugados || 0}</span>
                    <span className="stat-label">Partidos</span>
                  </div>
                  <div className="stat-item">
                    <span className="stat-value">{jugador.estadisticas?.goles || 0}</span>
                    <span className="stat-label">Goles</span>
                  </div>
                  <div className="stat-item">
                    <span className="stat-value">{jugador.estadisticas?.asistencias || 0}</span>
                    <span className="stat-label">Asistencias</span>
                  </div>
                </div>
                <div className="jugador-actions" style={{ display:'flex', gap:'8px', alignItems:'center' }}>
                  <button className="btn btn-icon" title="Editar jugador" aria-label="Editar jugador">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" width="18" height="18"><path strokeLinecap="round" strokeLinejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931z"/></svg>
                  </button>
                  <button className="btn btn-icon" title="Ver perfil" aria-label="Ver perfil">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" width="18" height="18"><path strokeLinecap="round" strokeLinejoin="round" d="M2.25 12s3.75-6.75 9.75-6.75S21.75 12 21.75 12s-3.75 6.75-9.75 6.75S2.25 12 2.25 12z"/><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                  </button>
                  <button 
                    className="btn btn-icon btn-danger"
                    onClick={() => handleDeletePlayer(jugador.id)}
                    title="Eliminar jugador"
                    aria-label="Eliminar jugador"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" width="18" height="18"><path strokeLinecap="round" strokeLinejoin="round" d="M6 7h12m-9 0v-.5A1.5 1.5 0 0110.5 5h3A1.5 1.5 0 0115 6.5V7m-7 0v11a2 2 0 002 2h4a2 2 0 002-2V7"/></svg>
                  </button>
                </div>
              </div>
            ))}
          </div>

          {jugadores.length === 0 && (
            <div className="empty-state">
              <h3>No hay jugadores registrados</h3>
              <p>AÃ±ade jugadores a este equipo para comenzar a gestionar tu plantilla.</p>
            </div>
          )}
        </>
      )}

      {/* Formulario de Nuevo Jugador */}
      {showNewPlayerForm && (
        <div className="form-modal">
          <form onSubmit={handleCreatePlayer} className="new-player-form">
            <h4>Nuevo Jugador</h4>
            <div className="input-row">
              <div className="input-group">
                <label>Nombre *</label>
                <input
                  type="text"
                  value={newPlayer.nombre}
                  onChange={(e) => setNewPlayer({...newPlayer, nombre: e.target.value})}
                  required
                />
              </div>
              <div className="input-group">
                <label>Apellido *</label>
                <input
                  type="text"
                  value={newPlayer.apellido}
                  onChange={(e) => setNewPlayer({...newPlayer, apellido: e.target.value})}
                  required
                />
              </div>
            </div>
            <div className="input-row">
              <div className="input-group">
                <label>Fecha de Nacimiento *</label>
                <input
                  type="date"
                  value={newPlayer.fechaNacimiento}
                  onChange={(e) => setNewPlayer({...newPlayer, fechaNacimiento: e.target.value})}
                  required
                />
              </div>
              <div className="input-group">
                <label>NÃºmero de Camiseta *</label>
                <input
                  type="number"
                  value={newPlayer.numeroCamiseta}
                  onChange={(e) => setNewPlayer({...newPlayer, numeroCamiseta: e.target.value})}
                  min="1"
                  max="99"
                  required
                />
              </div>
            </div>
            <div className="input-group">
              <label>PosiciÃ³n *</label>
              <select
                value={newPlayer.posicion}
                onChange={(e) => setNewPlayer({...newPlayer, posicion: e.target.value})}
                required
              >
                <option value="">Seleccionar posiciÃ³n</option>
                {posiciones.map(posicion => (
                  <option key={posicion} value={posicion}>
                    {posicion}
                  </option>
                ))}
              </select>
            </div>
            <div className="input-row">
              <div className="input-group">
                <label>TelÃ©fono</label>
                <input
                  type="tel"
                  value={newPlayer.telefono}
                  onChange={(e) => setNewPlayer({...newPlayer, telefono: e.target.value})}
                />
              </div>
              <div className="input-group">
                <label>Email</label>
                <input
                  type="email"
                  value={newPlayer.email}
                  onChange={(e) => setNewPlayer({...newPlayer, email: e.target.value})}
                />
              </div>
            </div>
            <div className="input-group">
              <label>DirecciÃ³n</label>
              <input
                type="text"
                value={newPlayer.direccion}
                onChange={(e) => setNewPlayer({...newPlayer, direccion: e.target.value})}
              />
            </div>
            <div className="input-row">
              <div className="input-group">
                <label>Contacto de Emergencia</label>
                <input
                  type="text"
                  value={newPlayer.contactoEmergencia}
                  onChange={(e) => setNewPlayer({...newPlayer, contactoEmergencia: e.target.value})}
                  placeholder="Nombre del contacto"
                />
              </div>
              <div className="input-group">
                <label>TelÃ©fono de Emergencia</label>
                <input
                  type="tel"
                  value={newPlayer.telefonoEmergencia}
                  onChange={(e) => setNewPlayer({...newPlayer, telefonoEmergencia: e.target.value})}
                />
              </div>
            </div>
            <div className="form-actions">
              <button type="submit" className="btn-primary">AÃ±adir Jugador</button>
              <button 
                type="button" 
                className="btn-secondary"
                onClick={() => setShowNewPlayerForm(false)}
              >
                Cancelar
              </button>
            </div>
          </form>
        </div>
      )}

      {/* Formulario de InvitaciÃ³n */}
      {showInviteForm && (
        <div className="form-modal">
          <form onSubmit={handleSendInvite} className="invite-form">
            <h4>Enviar InvitaciÃ³n</h4>
            <div className="input-group">
              <label>Email del Invitado *</label>
              <input
                type="email"
                value={inviteData.email}
                onChange={(e) => setInviteData({...inviteData, email: e.target.value})}
                required
              />
            </div>
            <div className="input-group">
              <label>Rol *</label>
              <select
                value={inviteData.rol}
                onChange={(e) => setInviteData({...inviteData, rol: e.target.value})}
                required
              >
                {roles.map(rol => (
                  <option key={rol.value} value={rol.value}>
                    {rol.label}
                  </option>
                ))}
              </select>
            </div>
            {inviteData.rol === 'jugador' && (
              <div className="input-group">
                <label>Equipo *</label>
                <select
                  value={inviteData.equipoId}
                  onChange={(e) => setInviteData({...inviteData, equipoId: e.target.value})}
                  required
                >
                  <option value="">Seleccionar equipo</option>
                  {equipos.map(equipo => (
                    <option key={equipo.id} value={equipo.id}>
                      {equipo.nombre}
                    </option>
                  ))}
                </select>
              </div>
            )}
            <div className="form-actions">
              <button type="submit" className="btn-primary">Enviar InvitaciÃ³n</button>
              <button 
                type="button" 
                className="btn-secondary"
                onClick={() => setShowInviteForm(false)}
              >
                Cancelar
              </button>
            </div>
          </form>
        </div>
      )}
    </div>
  );
}

export default GestionJugadores;
